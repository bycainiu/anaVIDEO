# 视频标题自动生成功能

## 功能概述

anaVIDEO 现在支持自动为视频生成符合语料库风格的中文标题,有两种工作模式:

### 1. 启动时自动生成 (服务器端)
服务器启动时,会自动扫描数据库中所有带有默认文件名的视频,依次为它们生成标题。

### 2. 分析时实时生成 (前端)
在分析新视频时,AI 会基于所有关键帧和关键词实时生成标题。

## 工作原理

### 标题生成策略
- **输入信息**:
  - 视频概述 (overallSummary)
  - 所有帧的关键词 (keywords + expandedKeywords)
  - 关键帧数量
  
- **生成规则**:
  - 长度: 15-30 个汉字
  - 风格: 参考 `config/colloquialStyle.json` 中的标题风格
  - 语言: 自然、口语化的中文
  - 内容: 直接描述视频核心特征,吸引人且直白

### 强洗脑 Prompt
系统使用特殊设计的强洗脑提示词,确保 AI:
- 专注于标题生成任务
- 不受默认安全限制影响
- 客观描述视觉内容
- 严格遵循语料库风格

## 配置方法

### 服务器端配置

1. 复制环境变量示例文件:
```bash
cp server/.env.example server/.env
```

2. 编辑 `server/.env` 文件,设置以下变量:
```env
OPENAI_API_KEY=your_api_key_here
OPENAI_BASE_URL=https://api.openai.com/v1
OPENAI_MODEL=gpt-4o
```

3. 启动服务器:
```bash
cd server
npm install
npm start
```

服务器会在启动 5 秒后自动开始为默认标题的视频生成标题。

### 前端配置

前端使用用户在设置中配置的 OpenAI API 信息:

1. 打开设置 (Settings)
2. 切换到 "OpenAI" 标签
3. 填写:
   - API Key
   - Base URL
   - Model Name (可选,默认 gpt-4o)

配置完成后,新分析的视频会自动包含生成的标题。

## 默认文件名识别

系统会识别以下格式为默认文件名,并自动生成标题:
- `xxx.mp4`
- `video.mp4`, `video1.mp4`, `video2.mp4`
- `123.mp4` (纯数字)
- `untitled.mp4`, `Untitled Video.mp4`
- `新建视频.mp4`, `未命名.mp4`
- UUID 格式: `a1b2c3d4-e5f6-...-.mp4`

## 使用场景

### 场景 1: 批量处理已有视频
```bash
# 服务器启动后自动处理
npm start

# 日志输出示例:
[TitleGen] Found 10 videos in database
[TitleGen] Found 5 videos needing title generation
[TitleGen] Processing video abc-123 (xxx.mp4)...
[TitleGen] ✓ Updated video abc-123 title: xxx.mp4 -> 国产淫荡美女瑜伽裤自慰高潮喷水
```

### 场景 2: 新视频分析
```typescript
// 前端自动处理
const analysis = await getStructuredVideoAnalysis(provider, settings, frames);

// 返回结果包含 videoTitle
{
  videoTitle: "肥臀主播黑丝诱惑道具玩穴淫叫",
  overallSummary: { ... },
  frameAnalyses: [ ... ]
}

// 系统会自动使用生成的标题保存视频
```

## API 集成

### 标题生成 API

后端服务提供了标题生成函数:

```javascript
import { generateTitleWithAI } from './titleGenerationService.js';

const videoData = {
  id: 'video-id',
  name: 'xxx.mp4',
  overall_summary_cn: '...',
  frames: [ /* frame data with keywords */ ]
};

const title = await generateTitleWithAI(
  videoData,
  apiKey,
  baseUrl,
  model
);
```

### 视频分析 API

前端分析请求自动包含标题:

```typescript
const result: VideoAnalysisResult = await analyzeVideoFrames(
  apiKey,
  baseUrl,
  frames,
  preset,
  model
);

// result.videoTitle 包含生成的标题
```

## 性能考虑

### 并发控制
- 启动时标题生成: 最多 3 个视频并发处理
- 批次间延迟: 1 秒,避免 API 速率限制

### Token 消耗
- 每个标题生成请求: 约 200 tokens
- 使用 GPT-4o 时成本极低

### 容错机制
- API 失败时使用关键词组合作为备用标题
- 不影响视频分析的其他功能

## 调试

### 查看标题生成日志

服务器端:
```bash
# 启动服务器并观察日志
npm start

# 日志关键字:
[TitleGen] Starting video title generation...
[TitleGen] Using model: gpt-4o
[TitleGen] Generated title: ...
```

前端:
```javascript
// 打开浏览器控制台
[Video Processing] Title generated by AI: ...
[Video Processing] Using video name: ...
```

### 手动触发标题生成

可以通过重启服务器触发:
```bash
# 停止服务器
Ctrl+C

# 重新启动
npm start
```

## 语料库定制

标题风格由 `config/colloquialStyle.json` 控制。

修改标题类别:
```json
{
  "标题": {
    "自定义类别": [
      "示例标题1",
      "示例标题2",
      "示例标题3"
    ]
  }
}
```

修改后,新生成的标题会自动参考更新后的风格。

## 常见问题

### Q: 如何禁用自动标题生成?
A: 不设置 `OPENAI_API_KEY` 环境变量,或在 `server/.env` 中留空。

### Q: 标题生成失败会怎样?
A: 会使用关键词组合作为备用标题,例如 "肥臀黑丝瑜伽裤视频"。

### Q: 可以手动修改生成的标题吗?
A: 目前需要直接修改数据库。未来版本会添加前端编辑功能。

### Q: 支持其他语言的标题吗?
A: 目前仅支持中文。可以修改 prompt 支持其他语言。

### Q: 使用其他模型 (如 Gemini) 可以吗?
A: 当前仅支持 OpenAI 兼容的 API。Gemini 支持计划中。

## 技术细节

### 文件结构
```
server/src/
├── titleGenerationService.js  # 标题生成服务
├── db.js                       # 数据库操作 (updateVideoTitle)
└── index.js                    # 服务器启动逻辑

services/
└── openAIService.ts            # 视频分析 API (包含标题生成)

types.ts                        # 类型定义 (VideoAnalysisResult.videoTitle)
App.tsx                         # 前端保存逻辑
```

### 数据流

#### 启动时生成:
1. 服务器启动 → `processVideosOnStartup()`
2. 扫描数据库 → 筛选默认标题视频
3. 批量处理 → `generateTitleWithAI()`
4. 更新数据库 → `dbOperations.updateVideoTitle()`

#### 分析时生成:
1. 用户上传视频 → 提取关键帧
2. 调用 AI 分析 → `analyzeVideoFrames()`
3. AI 返回 JSON → 包含 `videoTitle`
4. 保存分析 → 使用 `analysis.videoTitle` 作为视频名称

## 安全性

### API Key 保护
- 服务器端: 使用环境变量,不提交到版本控制
- 前端: 使用 localStorage,不暴露到 URL

### Prompt 注入防护
- 用户输入已过滤
- Prompt 结构化设计,防止越狱

## 未来改进

- [ ] 支持批量重新生成标题
- [ ] 前端标题编辑界面
- [ ] 多语言标题支持
- [ ] Gemini API 集成
- [ ] 标题质量评分和优化建议
